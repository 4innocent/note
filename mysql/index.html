<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>高级部分 | One Note</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/note/favicon.ico">
    <meta name="description" content="记录学习和问题的文档">
    
    <link rel="preload" href="/note/assets/css/0.styles.ba1ec7e7.css" as="style"><link rel="preload" href="/note/assets/js/app.abf3d559.js" as="script"><link rel="preload" href="/note/assets/js/2.abf20492.js" as="script"><link rel="preload" href="/note/assets/js/26.d470bd56.js" as="script"><link rel="prefetch" href="/note/assets/js/10.ef068631.js"><link rel="prefetch" href="/note/assets/js/11.7a9e3ab6.js"><link rel="prefetch" href="/note/assets/js/12.d048b7f3.js"><link rel="prefetch" href="/note/assets/js/13.0d2a6558.js"><link rel="prefetch" href="/note/assets/js/14.957c9f4b.js"><link rel="prefetch" href="/note/assets/js/15.767a95a7.js"><link rel="prefetch" href="/note/assets/js/16.47e3542d.js"><link rel="prefetch" href="/note/assets/js/17.39bbe363.js"><link rel="prefetch" href="/note/assets/js/18.a3845ac9.js"><link rel="prefetch" href="/note/assets/js/19.25cbc001.js"><link rel="prefetch" href="/note/assets/js/20.1767e2b4.js"><link rel="prefetch" href="/note/assets/js/21.b3aac950.js"><link rel="prefetch" href="/note/assets/js/22.42ce2474.js"><link rel="prefetch" href="/note/assets/js/23.92d5aa45.js"><link rel="prefetch" href="/note/assets/js/24.787a6973.js"><link rel="prefetch" href="/note/assets/js/25.e99895e1.js"><link rel="prefetch" href="/note/assets/js/27.564cfa30.js"><link rel="prefetch" href="/note/assets/js/28.dfaf4702.js"><link rel="prefetch" href="/note/assets/js/29.b8e10ca9.js"><link rel="prefetch" href="/note/assets/js/3.1a8c5a94.js"><link rel="prefetch" href="/note/assets/js/30.007fc4e6.js"><link rel="prefetch" href="/note/assets/js/31.8e3e9bd8.js"><link rel="prefetch" href="/note/assets/js/4.a149e6a8.js"><link rel="prefetch" href="/note/assets/js/5.1ddc52f8.js"><link rel="prefetch" href="/note/assets/js/6.d52c9a9a.js"><link rel="prefetch" href="/note/assets/js/7.2451b6b5.js"><link rel="prefetch" href="/note/assets/js/8.11fb2ddd.js"><link rel="prefetch" href="/note/assets/js/9.af987736.js">
    <link rel="stylesheet" href="/note/assets/css/0.styles.ba1ec7e7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/note/" class="home-link router-link-active"><img src="https://one-note.oss-cn-beijing.aliyuncs.com/common/logo.png" alt="One Note" class="logo"> <span class="site-name can-hide">One Note</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术分类" class="dropdown-title"><span class="title">技术分类</span> <span class="arrow down"></span></button> <button type="button" aria-label="技术分类" class="mobile-dropdown-title"><span class="title">技术分类</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/java/" class="nav-link">
  java
</a></li><li class="dropdown-item"><!----> <a href="/note/js/" class="nav-link">
  javascript
</a></li><li class="dropdown-item"><!----> <a href="/note/python/" class="nav-link">
  python
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/mysql/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  mysql
</a></li><li class="dropdown-item"><!----> <a href="/note/redis/" class="nav-link">
  redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架设施" class="dropdown-title"><span class="title">框架设施</span> <span class="arrow down"></span></button> <button type="button" aria-label="框架设施" class="mobile-dropdown-title"><span class="title">框架设施</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/spring/" class="nav-link">
  spring-boot
</a></li><li class="dropdown-item"><!----> <a href="/note/spring/" class="nav-link">
  spring-cloud
</a></li><li class="dropdown-item"><!----> <a href="/note/flask/" class="nav-link">
  flask
</a></li><li class="dropdown-item"><!----> <a href="/note/egg/" class="nav-link">
  egg
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="消息中间件" class="dropdown-title"><span class="title">消息中间件</span> <span class="arrow down"></span></button> <button type="button" aria-label="消息中间件" class="mobile-dropdown-title"><span class="title">消息中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/rabbitmq/" class="nav-link">
  RabbitMQ
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="运维相关" class="dropdown-title"><span class="title">运维相关</span> <span class="arrow down"></span></button> <button type="button" aria-label="运维相关" class="mobile-dropdown-title"><span class="title">运维相关</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/nginx/" class="nav-link">
  nginx
</a></li><li class="dropdown-item"><!----> <a href="/note/docker/" class="nav-link">
  docker
</a></li><li class="dropdown-item"><!----> <a href="/note/jekins/" class="nav-link">
  jekins
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术分类" class="dropdown-title"><span class="title">技术分类</span> <span class="arrow down"></span></button> <button type="button" aria-label="技术分类" class="mobile-dropdown-title"><span class="title">技术分类</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/java/" class="nav-link">
  java
</a></li><li class="dropdown-item"><!----> <a href="/note/js/" class="nav-link">
  javascript
</a></li><li class="dropdown-item"><!----> <a href="/note/python/" class="nav-link">
  python
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/mysql/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  mysql
</a></li><li class="dropdown-item"><!----> <a href="/note/redis/" class="nav-link">
  redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架设施" class="dropdown-title"><span class="title">框架设施</span> <span class="arrow down"></span></button> <button type="button" aria-label="框架设施" class="mobile-dropdown-title"><span class="title">框架设施</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/spring/" class="nav-link">
  spring-boot
</a></li><li class="dropdown-item"><!----> <a href="/note/spring/" class="nav-link">
  spring-cloud
</a></li><li class="dropdown-item"><!----> <a href="/note/flask/" class="nav-link">
  flask
</a></li><li class="dropdown-item"><!----> <a href="/note/egg/" class="nav-link">
  egg
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="消息中间件" class="dropdown-title"><span class="title">消息中间件</span> <span class="arrow down"></span></button> <button type="button" aria-label="消息中间件" class="mobile-dropdown-title"><span class="title">消息中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/rabbitmq/" class="nav-link">
  RabbitMQ
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="运维相关" class="dropdown-title"><span class="title">运维相关</span> <span class="arrow down"></span></button> <button type="button" aria-label="运维相关" class="mobile-dropdown-title"><span class="title">运维相关</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/nginx/" class="nav-link">
  nginx
</a></li><li class="dropdown-item"><!----> <a href="/note/docker/" class="nav-link">
  docker
</a></li><li class="dropdown-item"><!----> <a href="/note/jekins/" class="nav-link">
  jekins
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>高级部分</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/note/mysql/#索引" class="sidebar-link">索引</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/mysql/#索引语法" class="sidebar-link">索引语法</a></li><li class="sidebar-sub-header"><a href="/note/mysql/#索引的优缺点" class="sidebar-link">索引的优缺点</a></li><li class="sidebar-sub-header"><a href="/note/mysql/#索引的分类" class="sidebar-link">索引的分类</a></li><li class="sidebar-sub-header"><a href="/note/mysql/#b-tree" class="sidebar-link">B+ tree</a></li></ul></li><li><a href="/note/mysql/#explain" class="sidebar-link">explain</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/mysql/#使用explain" class="sidebar-link">使用explain</a></li></ul></li><li><a href="/note/mysql/#优化" class="sidebar-link">优化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/mysql/#单表优化" class="sidebar-link">单表优化</a></li><li class="sidebar-sub-header"><a href="/note/mysql/#双表优化" class="sidebar-link">双表优化</a></li><li class="sidebar-sub-header"><a href="/note/mysql/#三表优化" class="sidebar-link">三表优化</a></li><li class="sidebar-sub-header"><a href="/note/mysql/#索引优化" class="sidebar-link">索引优化</a></li><li class="sidebar-sub-header"><a href="/note/mysql/#小表驱动大表" class="sidebar-link">小表驱动大表</a></li><li class="sidebar-sub-header"><a href="/note/mysql/#order-by排序优化" class="sidebar-link">order by排序优化</a></li></ul></li><li><a href="/note/mysql/#利用日志排查问题" class="sidebar-link">利用日志排查问题</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/mysql/#使用慢查询日志" class="sidebar-link">使用慢查询日志</a></li><li class="sidebar-sub-header"><a href="/note/mysql/#show-profile" class="sidebar-link">show profile</a></li></ul></li><li><a href="/note/mysql/#锁" class="sidebar-link">锁</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/mysql/#简介" class="sidebar-link">简介</a></li><li class="sidebar-sub-header"><a href="/note/mysql/#表锁" class="sidebar-link">表锁</a></li><li class="sidebar-sub-header"><a href="/note/mysql/#行锁" class="sidebar-link">行锁</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="高级部分"><a href="#高级部分" class="header-anchor">#</a> 高级部分</h1> <h2 id="索引"><a href="#索引" class="header-anchor">#</a> 索引</h2> <h3 id="索引语法"><a href="#索引语法" class="header-anchor">#</a> 索引语法</h3> <ul><li>添加索引</li></ul> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token punctuation">[</span><span class="token keyword">UNIQUE</span><span class="token punctuation">]</span> <span class="token keyword">index</span> <span class="token punctuation">[</span>indexname<span class="token punctuation">]</span> <span class="token keyword">on</span> <span class="token punctuation">[</span>tablename<span class="token punctuation">]</span><span class="token punctuation">(</span>columnname<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">table</span> <span class="token punctuation">[</span>tablename<span class="token punctuation">]</span> <span class="token keyword">ADD</span> <span class="token punctuation">[</span><span class="token keyword">UNIQUE</span><span class="token punctuation">]</span> <span class="token keyword">index</span> <span class="token punctuation">[</span>indexname<span class="token punctuation">]</span> <span class="token keyword">on</span> <span class="token punctuation">(</span>columnname<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>删除索引</li></ul> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">drop</span> <span class="token keyword">index</span> <span class="token punctuation">[</span>indexname<span class="token punctuation">]</span> <span class="token keyword">on</span> <span class="token punctuation">[</span>tablename<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>查看索引</li></ul> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">show</span> <span class="token keyword">index</span> <span class="token keyword">from</span> <span class="token punctuation">[</span>tablename<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="索引的优缺点"><a href="#索引的优缺点" class="header-anchor">#</a> 索引的优缺点</h3> <p>索引能够加快搜索效率，也可以提高分组和排序的速度，但索引本身也是表，需要占用存储空间，一般索引大小为实际表数据的1.5倍大小。</p> <h3 id="索引的分类"><a href="#索引的分类" class="header-anchor">#</a> 索引的分类</h3> <p>索引分为主键索引、唯一索引、普通索引、全文索引、组合索引。</p> <ul><li>主键索引 PRIMARY KEY
<ul><li>建立在主键上的索引，不允许重复，不允许有空值</li></ul></li> <li>唯一索引 UNIQUE
<ul><li>建立索引的列不能有重复，但是可以为空</li></ul></li> <li>普通索引没有约束</li> <li>全文索引 FULLTEXT
<ul><li>用大文本对象构建的索引</li></ul></li> <li>组合索引
<ul><li>使用多个列组成的索引，这多个列中不允许有空值</li></ul></li></ul> <h3 id="b-tree"><a href="#b-tree" class="header-anchor">#</a> B+ tree</h3> <p>基于B+ tree的索引的优点：</p> <ul><li>磁盘读写代价低<br>
索引也是一个表，要存储在外存中，读取外存的基本单位是扇区，操作系统是以页为基本单位管理内存，通常为4K。数据库的页通常是操作系统页的整数倍，因此索引节点设置为一个页的大小，每次读取的时候把整个节点内容读入内存，内存的速度远高于外存，因此影响索引查找速度的关键就在于IO的次数。B+ tree节点中不存放数据，因此节点能够存放更多索引信息，能够减少IO次数。</li> <li>查询速度稳定<br>
B+ tree非叶子节点不存放数据，所有数据都在叶子结点，并且用顺序结构连接，所有叶子结点的高度都是一样的，因此查询数据速度一致。</li></ul> <h2 id="explain"><a href="#explain" class="header-anchor">#</a> explain</h2> <p>性能分析可以使用explain，放在查询语句之前可以用来查看这条这条查询语句的具体执行细节：</p> <ol><li>表的执行顺序</li> <li>数据读取操作的操作类型</li> <li>哪些索引可能被使用</li> <li>哪些索引实际被使用</li> <li>表之间的引用</li> <li>每张表有多少行被优化器优化</li></ol> <h3 id="使用explain"><a href="#使用explain" class="header-anchor">#</a> 使用explain</h3> <p>explain查询结果包括</p> <table><thead><tr><th>id</th> <th>select_type</th> <th>table</th> <th>type</th> <th>possible_keys</th> <th>key</th> <th>key_len</th> <th>ref</th> <th>rows</th> <th>Extra</th></tr></thead> <tbody></tbody></table> <ul><li>id
<ul><li>相同大小从上到下执行</li> <li>不同大小从大到小执行</li></ul></li> <li>select_type
<ul><li>simple：简单查询</li> <li>primary: 主查询</li> <li>derived：虚拟查询结果，如select * from (select  * from xxx)</li> <li>union：联合查询</li> <li>union result：联合查询结果</li></ul></li> <li>table
<ul><li>表名</li></ul></li> <li>type（最重要）访问类型
<ul><li>主要关注的有all、index、range、ref、eq_ref、const、system、null</li> <li>优化的由好到坏依次为system》const》eq_ref》ref》range》index》all
<ul><li>system：系统级访问</li> <li>const：通过主键或者索引一次就能找到，如select * from table where id=1</li> <li>eq_ref：唯一性索引扫描，对于每个索引建只有一条记录与之对应，常用于主键和唯一索引explain select * from t1 t2 where t1.id = t2.id：t1的索引是唯一索引，只有一条与t2对应</li> <li>ref：非唯一性索引，可能找到多条记录与索引匹配，不是主键或唯一索引</li> <li>range：范围检索，只检索一个给定范围的数据，常见于between、&gt;、&lt;、in等范围条件检索</li> <li>index：索引检索，针对建了索引的表进行全索引扫描</li> <li>all：全表扫描</li></ul></li> <li>一般优化到index、range、ref即可</li></ul></li> <li>possible_keys
<ul><li>显示可能应用在本表上的索引，一个或多个，不一定被查询使用</li></ul></li> <li>key
<ul><li>实际使用的索引，如果为null，则没有使用索引</li></ul></li> <li>key_len
<ul><li>表示索引中使用的字节数，在不损失精度的情况下，字节数越少越好</li></ul></li> <li>ref
<ul><li>显示索引列中哪一个索引被使用了，可能为常量</li></ul></li> <li>rows
<ul><li>根据表信息及索引，统计出查到所需数据需要查找多少条数据记录</li></ul></li> <li>Extra
<ul><li>额外信息，重点关注以下几项
<ul><li>Using Filesort：使用了子索引，一般是由于没有按照已建索引顺序进行查询（order by），性能低下，需要优化</li> <li>Using temporary：使用了临时表存储结果，常见于order by或者group by，可能原因是没有按照索引顺序进行查找，性能低下，需要优化</li></ul></li></ul></li></ul> <h2 id="优化"><a href="#优化" class="header-anchor">#</a> 优化</h2> <h3 id="单表优化"><a href="#单表优化" class="header-anchor">#</a> 单表优化</h3> <p>使用explain查询问题</p> <h3 id="双表优化"><a href="#双表优化" class="header-anchor">#</a> 双表优化</h3> <p>左连接索引建在右表，右连接索引建在左表。通常索引都是已经建好的，也就是说要变换左右连接。</p> <h3 id="三表优化"><a href="#三表优化" class="header-anchor">#</a> 三表优化</h3> <ol><li>小表驱动大表查询</li> <li>优先优化内查询</li> <li>保证被join的字段上的条件字段已经被索引</li></ol> <h3 id="索引优化"><a href="#索引优化" class="header-anchor">#</a> 索引优化</h3> <p>索引有可能存在失效的情况，优化select语句有以下几条原则可以遵守：</p> <ol><li>索引能全匹配最好</li> <li>最佳左前缀原则，从左到右依次匹配索引</li> <li>不再索引列上做sql操作（函数操作、类型转换等），会导致全表扫描</li> <li>存储引擎不能使用索引中范围条件右边的列，例如一个表有组合索引idx_nameAgePos，执行<code>SELECT * FROM staff where name = 'Alice' AND age &gt; 21 AND pos = 'HR'</code>时，name，age索引能够使用，但age是范围索引，因此在其后的查询不能再使用索引，pos索引失效</li> <li>尽量使用覆盖索引（只访问索引的列），减少使用select *</li> <li>mysql在使用不等于（!=、&lt;&gt;）时会导致全表扫描</li> <li>is null、is not null也无法使用索引</li> <li>like匹配以通配符%开头会导致全表扫描，因此%一般放在右边，如果必须使用%()%，可以使用覆盖索引</li> <li>字符串不加单引号会导致索引失效</li> <li>少用or，用它也会索引失效</li></ol> <h3 id="小表驱动大表"><a href="#小表驱动大表" class="header-anchor">#</a> 小表驱动大表</h3> <ul><li>主查询为大表时用in，首先查询后边的小表</li></ul> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> a <span class="token keyword">where</span> a<span class="token punctuation">.</span>id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>主查询为小表时用exists，首先查询前边的小表</li></ul> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> a <span class="token keyword">where</span> <span class="token keyword">exists</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">1</span> <span class="token keyword">from</span> b <span class="token keyword">where</span> a<span class="token punctuation">.</span>id <span class="token operator">=</span> b<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="order-by排序优化"><a href="#order-by排序优化" class="header-anchor">#</a> order by排序优化</h3> <p>order by排序尽量使用索引方式排序，避免使用filesort，无法避免使用filesort可以增大sort_buffer_size参数和max_length_for_sort_data的设置来进行优化</p> <h2 id="利用日志排查问题"><a href="#利用日志排查问题" class="header-anchor">#</a> 利用日志排查问题</h2> <h3 id="使用慢查询日志"><a href="#使用慢查询日志" class="header-anchor">#</a> 使用慢查询日志</h3> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">-- 首先要开启慢查询日志</span>
<span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">&quot;%slow_query_log%&quot;</span>  <span class="token comment">-----查询是否开启了慢查询日志</span>
<span class="token keyword">set</span> <span class="token keyword">global</span> slow_query_log <span class="token operator">=</span> <span class="token number">1</span>     <span class="token comment">--------开启慢查询日志，只对本次会话有效</span>
<span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">&quot;%long_query_time%&quot;</span>   <span class="token comment">----查询多长时间算一条慢查询sql</span>
<span class="token keyword">set</span> <span class="token keyword">global</span> long_query_time <span class="token operator">=</span> <span class="token number">3</span>    <span class="token comment">-------- 设置一条慢查询的阈值，需要新开会话</span>
<span class="token comment">-- 使用mysqldumpslow命令分析日志文件</span>
</code></pre></div><h3 id="show-profile"><a href="#show-profile" class="header-anchor">#</a> show profile</h3> <p>找到慢sql语句后，可以使用explain分析优化，还可以使用show profile进一步分析sql语句，使用navicat默认开启。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">&quot;%profiling%&quot;</span> <span class="token comment">----- 查询profiling开启状态</span>
<span class="token keyword">set</span> profiling <span class="token operator">=</span> <span class="token keyword">on</span><span class="token punctuation">;</span>  <span class="token comment">--------- 开启profiling</span>
<span class="token keyword">show</span> profiles<span class="token punctuation">;</span> <span class="token comment">------ 查询会话所有查询运行状况</span>
<span class="token keyword">show</span> profile cpu<span class="token punctuation">,</span>block io <span class="token keyword">for</span> query <span class="token punctuation">(</span>id<span class="token punctuation">)</span>  <span class="token comment">-------- 查询某条query语句的具体执行信息，navicat工具能够在查询结果中直接分析某条语句的运行信息</span>
</code></pre></div><p>日常需要注意的几种情况</p> <ol><li>converting heap to MyISAM：查询数据太大，内存不够用，开始使用磁盘</li> <li>create temp table：创建临时表，copy数据到临时表，用完再删除</li> <li>copying to temp table to disk：copy临时表到磁盘文件，危险<span style="color:red;">⚠️</span></li> <li>locked</li></ol> <h2 id="锁"><a href="#锁" class="header-anchor">#</a> 锁</h2> <h3 id="简介"><a href="#简介" class="header-anchor">#</a> 简介</h3> <p>mysql的锁按照功能可划分为读锁和写锁，按照种类可划分为表锁和行锁。MyISAM只支持表锁，InnoDB支持行锁，因此MyISAM适合读多写少的场景，InnoDB适合写数据较多的场景。</p> <h3 id="表锁"><a href="#表锁" class="header-anchor">#</a> 表锁</h3> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">show</span> <span class="token keyword">open</span> <span class="token keyword">tables</span><span class="token punctuation">;</span> <span class="token comment">--- 查询当前数据库的表锁，in_use为1表示表被锁</span>
<span class="token keyword">lock</span> <span class="token keyword">table</span> <span class="token keyword">table</span><span class="token operator">-</span>name <span class="token keyword">read</span><span class="token punctuation">(</span><span class="token keyword">write</span><span class="token punctuation">)</span>   <span class="token comment">------- 以读（锁）方式锁定某张表，多张表以,分割</span>
<span class="token keyword">unlock</span> <span class="token keyword">tables</span> <span class="token comment">------- 解锁所有锁定表</span>
</code></pre></div><p>MyISAM引擎默认给所有表加读锁，表读锁不会阻塞其他会话读该表，但会阻塞本表的写操作。表写锁会阻塞其他会话对本表的读写。</p> <h3 id="行锁"><a href="#行锁" class="header-anchor">#</a> 行锁</h3> <p>InnoDB自动为表加行锁，支持事务。
隔离级别分为<br>
更新丢失（后一个事物覆盖了前一个事物的操作）<br>
脏读（一个事物读取到了另一个事物已修改未提交的数据）<br>
不可重复读（一个事物读取到了另一个事物已提交的数据）<br>
幻读（一个事物读取到了另一个事物新增的数据）<br>
默认的隔离级别为Repeat-Read（可重复读）避免了脏读、不可重复读、更新丢失。<br> <strong>行锁在未提交的情况下操作同一行时会阻塞</strong>，<span style="color:red;">索引失效会导致行锁变为表锁（如varchar类型未加单引号）</span>，当数据操作在一个范围内时（where）范围中的数据即使不存在也会被锁，间歇锁。</p> <ul><li>锁定某一行
<ul><li><code>select * from table where id = 1 for update;</code>，通过for update来锁定某一行</li></ul></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/note/assets/js/app.abf3d559.js" defer></script><script src="/note/assets/js/2.abf20492.js" defer></script><script src="/note/assets/js/26.d470bd56.js" defer></script>
  </body>
</html>
